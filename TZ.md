# Техническое задание: E-commerce платформа iPhone Dropship

## 1. Общее описание проекта

Интернет-магазин по продаже iPhone 15, 16, 17 с официальной гарантией Apple. Платформа включает реферальную программу, кешбек с покупок и меры против мошенничества.

**Целевая аудитория:** Украина, Россия, международные пользователи (поддержка 3 языков).

---

## 2. Технологический стек

| Компонент | Технология |
|-----------|------------|
| Frontend | Next.js 16+, React 19, TypeScript |
| Стилизация | Tailwind CSS |
| Backend | Next.js API Routes |
| База данных | PostgreSQL |
| ORM | Prisma |
| Аутентификация | NextAuth.js (credentials) |

---

## 3. Многоязычность (i18n)

**Языки:** EN (английский), RU (русский), UK (украинский).

- Переключатель языка — только в хедере на всех страницах.
- Сохранение выбранного языка (cookie/localStorage).
- Переводы: все UI-элементы, формы, сообщения об ошибках, контент товаров (названия, описания, спецификации).

---

## 4. Публичные страницы

### 4.1. Главная страница (/)

- Заголовок и подзаголовок о кешбеке и реферальной программе.
- Две кнопки:
  - **«До каталогу»** — переход в каталог. Для авторизованных пользователей: крупная кнопка с градиентом и иконкой.
  - **«Присоединиться»** — переход на регистрацию. Отображается только для неавторизованных пользователей.
- Три карточки преимуществ: Кешбек до 5%, Реферальная программа, Официальная гарантия.

### 4.2. Каталог (/catalog)

- Сетка товаров (карточки) с изображением, названием, ценой, кешбеком, кнопкой «Купить».
- При клике — переход на страницу товара.

### 4.3. Страница товара (/product/[slug])

- Галерея изображений, название, цена, кешбек, характеристики (specs), описание.
- Кнопка «Купить» — переход на оформление заказа (checkout).

### 4.4. Реферальный редирект (/ref/[code])

- При переходе по ссылке `/ref/{referralCode}` — сохранение реферального кода в cookie (например, на 30 дней) и редирект на главную или каталог.
- При регистрации пользователь автоматически привязывается к рефереру.

---

## 5. Авторизация и регистрация

### 5.1. Регистрация (/register)

Поля: Email, пароль, имя, телефон.

Требования к паролю:
- Минимум 8 символов.
- Буквы и цифры.

Проверки:
- Email уникален.
- Телефон уникален (1 человек = 1 аккаунт, антифрод).
- Валидация формата.

После успешной регистрации — редирект на страницу входа. Поддержка реферального кода в URL (`?ref=...`).

### 5.2. Вход (/login)

- Email + пароль.
- После успешного входа — редирект на главную страницу (или на `callbackUrl`, если пользователь был перенаправлен с защищённой страницы).

---

## 6. Оформление заказа (Checkout)

**Путь:** /checkout?product=... (или аналогичный механизм передачи товара).

**Обязательная авторизация** для оформления заказа.

Поля формы:
- Имя получателя (обязательно).
- Способ доставки (радио-кнопки):
  - **Нова Пошта** — поля «Місто» и «Відділення (№ або адреса)».
  - **Кур'єр** — поле «Повна адреса».
- Телефон.
- Email (по умолчанию — email пользователя).
- Комментарий (опционально).

При сохранении формируется адрес доставки, например: `Нова Пошта: Київ, відділення №1` или полный адрес для курьера.

Создаётся заказ со статусом NEW. Оплата не интегрирована (Phase 2).

---

## 7. Личный кабинет (Dashboard)

**Путь:** /dashboard. Доступ только для авторизованных.

### 7.1. Главная дашборда

Карточки со статистикой:
- Доступный кешбек ($).
- Всего заработано ($).
- Всего рефералов.
- Активные рефералы (покупали за последние 90 дней).

Реферальная ссылка с кнопкой «Копировать».

Ссылки на подразделы: Мои рефералы, История кешбека, Мои заказы.

### 7.2. Мои рефералы (/dashboard/referrals)

Таблица: email, имя, дата регистрации рефералов пользователя.

### 7.3. История кешбека (/dashboard/cashback)

Список начислений: сумма, тип (своя покупка, покупка реферала, бонусы), статус (ожидание / доступно / выведено), дата.

### 7.4. Мои заказы (/dashboard/orders)

Список заказов пользователя: номер, статус, сумма, трекинг (если есть).

---

## 8. Админ-панель

**Путь:** /admin. Доступ только для пользователей с ролью ADMIN.

### 8.1. Навигация

Пункты: Дашборд, Товари, Заказы, Користувачі, Безкоштовний iPhone (20 реф), Налаштування.

### 8.2. Дашборд (/admin)

Сводка: количество пользователей, товаров, заказов, выручка.

### 8.3. Товары (/admin/products)

- Список товаров в таблице.
- Добавление товара: название, модель, память, цвет, цена, остаток, описание, изображения (массив URL), опубликован.
- Редактирование: те же поля + возможность добавлять и удалять изображения.
- Удаление товара.

### 8.4. Заказы (/admin/orders)

- Список заказов с деталями: пользователь, адрес доставки, товары, сумма, статус.
- Редактирование: смена статуса (NEW, PAID, PROCESSING, SHIPPED, DELIVERED, CANCELLED, REFUNDED), трекинг-номер.
- При переходе в DELIVERED — начисление кешбека (см. раздел «Кешбек»).

### 8.5. Пользователи (/admin/users)

- Список пользователей: email, имя, роль, количество заказов, дата регистрации.
- Блокировка/разблокировка. Заблокированный пользователь не может войти.

### 8.6. Безкоштовний iPhone за 20 рефералов (/admin/free-iphone)

**Условие:** пользователь имеет 20 и более рефералов, которые **купили** (статус заказа DELIVERED) в течение **последних 12 месяцев**.

Функционал:
- Список кандидатов (пользователи с ≥20 квалифицированными рефералами).
- По клику — раскрытие деталей: список рефералов с email, именем, датой доставки первого заказа, количеством заказов.
- Выбор модели iPhone (из товаров в наличии).
- Кнопка «Видати безкоштовний iPhone» — создание заказа на сумму 0, с флагом «бонус за 20 рефералов». Адрес доставки — заглушка (админ обновит при обработке).
- Один пользователь может получить бонус только один раз.

### 8.7. Настройки (/admin/settings)

- Минимальная сумма вывода ($) — по умолчанию 10.
- Длительность блокировки кешбека (дней) — по умолчанию 14.

---

## 9. Реферальная программа и кешбек

### 9.1. Бонусы за количество рефералов

| Активных рефералов* | Бонус |
|---------------------|-------|
| 10 | $50 |
| 15 | $100 |
| 20 | Бесплатный iPhone |

\* «Активный» — реферал с доставленным заказом. Для бесплатного iPhone — покупки за последний год.

Бонусы 10 и 15 — кешбек (на будущее, Phase 2). Бонус 20 — выдача через админку (см. п. 8.6).

### 9.2. Кешбек с покупок

- Собственная покупка: 3–5% (настраиваемо по товару).
- Покупка реферала: 2–5% (настраиваемо по товару).
- Кешбек начисляется только после доставки заказа.
- **Блокировка 14 дней:** кешбек становится доступным к выводу через 14 дней после даты доставки (период возврата).
- Логика: при смене статуса заказа на DELIVERED — создаются записи CashbackEntry со статусом PENDING и датой `availableAt = deliveredAt + 14 дней`. Периодически (при обращении к API дашборда или по cron) записи с `availableAt <= now` переводится в AVAILABLE.

### 9.3. Возвраты

При смене статуса заказа на REFUNDED — начисления кешбека по этому заказу переводятся в статус CANCELLED.

---

## 10. Меры против мошенничества (Anti-fraud)

| Мера | Реализация |
|------|------------|
| 1 человек = 1 аккаунт | Телефон уникален в БД. Проверка при регистрации. |
| Кешбек после 14 дней | Поле `availableAt`, статус PENDING до наступления даты. |
| Бесплатный iPhone | Ручная проверка в админке, 20 рефералов с покупками за год. |
| Блокировка пользователя | Поле `isBlocked`. Заблокированный не может войти. |
| Минимальная сумма вывода | Настраивается в SystemSetting (для будущих выводов). |
| IMEI | Поле в Order для верификации (заполняется при отправке). |

---

## 11. Модель данных (основные сущности)

### User
- id, email (unique), passwordHash, name, phone (unique), role (USER/ADMIN), isBlocked, referralCode (unique), referredById (FK → User).

### Product
- id, name, slug (unique), model, storage, color, description, specs (JSON), price, costPrice, stock, images (массив URL), isPublished.

### Order
- id, orderNumber (unique), userId, status (NEW/PAID/PROCESSING/SHIPPED/DELIVERED/CANCELLED/REFUNDED), shippingName, shippingAddress, shippingPhone, shippingEmail, comment, subtotal, shippingCost, total, trackingNumber, shippedAt, deliveredAt, imei, isFreeiPhoneBonus.

### OrderItem
- orderId, productId, quantity, price.

### CashbackEntry
- userId, amount, type (OWN_PURCHASE, REFERRAL_PURCHASE, BONUS_*), status (PENDING/AVAILABLE/PAID_OUT/CANCELLED), orderId, referralId, availableAt.

### SystemSetting
- key, value (минимальная сумма вывода, длительность блокировки кешбека).

### ReferralClick
- referralCode, userId, ipAddress, userAgent, utmSource, createdAt — для аналитики кликов по реферальной ссылке.

Модели PayoutMethod и PayoutRequest предусмотрены для Phase 2 (вывод средств).

---

## 12. Seed-данные

При первичном запуске необходимо создать:

- Админ: `admin@example.com` / `admin123`.
- Пользователь: `user@example.com` / `user123`.
- Несколько товаров (iPhone 15, 16, 17 разных конфигураций).
- SystemSetting: min_withdrawal = 10, cashback_hold_days = 14.

---

## 13. Структура проекта (рекомендуемая)

```
src/
├── app/
│   ├── api/              # API routes
│   ├── admin/            # Админ-панель
│   ├── catalog/
│   ├── checkout/
│   ├── dashboard/
│   ├── login/
│   ├── register/
│   ├── product/[slug]/
│   ├── ref/[code]/
│   └── page.tsx          # Главная
├── components/
├── lib/                  # Бизнес-логика (auth, orders, cashback, referral)
└── types/
```

---

## 14. Phase 2 (после MVP)

- Интеграция оплаты (Stripe).
- Управление заказами: редактирование адреса, IMEI.
- Заявки на вывод кешбека (PayoutRequest, PayoutMethod).
- Email-уведомления (подтверждение заказа, статусы).
- SMS-верификация телефона (опционально).

---

## 15. Phase 3 (перспектива)

- 2FA, OAuth.
- Расширенная аналитика.
- PWA.

---

## 16. Критерии приёмки MVP

1. Регистрация и вход работают, реферальный код сохраняется и привязывается при регистрации.
2. Каталог и страницы товаров отображаются с переводами на 3 языка.
3. Оформление заказа с выбором Нова Пошта / Курьер и соответствующими полями.
4. Личный кабинет: статистика, реферальная ссылка, список рефералов, история кешбека, список заказов.
5. Админка: CRUD товаров (включая изображения и описание), управление заказами (статусы, трекинг), блокировка пользователей, выдача бесплатного iPhone за 20 рефералов (с проверкой «покупали за год»), настройки системы.
6. Кешбек начисляется при DELIVERED, становится AVAILABLE через 14 дней.
7. Переключатель языка только в хедере.
8. Главная: для авторизованных — только кнопка каталога (увеличенная), для неавторизованных — каталог + Присоединиться.
9. После входа — редирект на главную.
